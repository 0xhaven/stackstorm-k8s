---
suite: Image Pull
templates:
  # primary template files
  - deployments.yaml
  - jobs.yaml
  - service-account.yaml

  # included templates must also be listed
  - configmaps_overrides.yaml
  - configmaps_packs.yaml
  - configmaps_rbac.yaml
  - configmaps_st2-conf.yaml
  - configmaps_st2-urls.yaml
  - configmaps_st2web.yaml
  - secrets_datastore_crypto_key.yaml
  - secrets_ssh.yaml
  - secrets_st2apikeys.yaml
  - secrets_st2auth.yaml
  - secrets_st2chatops.yaml

tests:
  - it: Jobs without st2.packs.images or st2.packs.volumes
    template: jobs.yaml
    set:
      st2:
        overrides: #Enabling the override mounts in register-content job.
          _global.yaml: |
            ---
            rules:
              defaults:
                enabled: false
        rbac: { enabled: true } # enable rbac job
        packs:
          images: [] # no extra packs to load
          volumes:
            enabled: false
          configs: {} # has one core.yaml config file by default (dicts get merged)
      jobs:
        extra_hooks: &extra_hooks_jobs
          - name: upgrade-warning
            hook: pre-upgrade, pre-rollback
            hook_weight: -5
            command: ["st2", "run", "--tail", "custom_pack.warn_about_upgrade"]
    release:
      name: st2ha
    asserts:
      - hasDocuments:
          count: 5

      - contains: &override_vol
          path: spec.template.spec.volumes
          content:
            name: st2-overrides-vol
            <<: *override_volume
   
   - contains: &override_vol_mnt
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: st2-overrides-vol
            mountPath: /opt/stackstorm/overrides
            <<: *override_mnt

      - notContains: *override_volume
      - notContains: *override_mnt

      - contains: *override_mnt
        documentIndex: 3 # register_content
      - contains: *override_volume
        documentIndex: 3 # register_content

      - notContains: *override_volume
        documentIndex: 0
      - notContains: *override_mnt
        documentIndex: 0

      - notContains: *override_volume
        documentIndex: 1
      - notContains: *override_mnt
        documentIndex: 1

      - notContains: *override_volume
        documentIndex: 2
      - notContains: *override_mnt
        documentIndex: 2
